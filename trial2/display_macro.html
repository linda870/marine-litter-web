<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Macroplastic Survey Display</title>
  <link rel="stylesheet" href="display_design.css" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="navbar" id="navbar">
    <div class="logo-title">
      <img src="logo.png" alt="Logo" class="logo">
      <span>Marine Litter Med Plus</span>
    </div>
    <div class="nav-links">
      <a href="home.html">Home</a>

      <div class="dropdown">
        <button class="dropdown-button">Macro Litter</button>
        <div class="dropdown-content">
          <a href="step1_macro.html">Conduct a survey</a>
          <a href="display_macro.html">Dashboard</a>
        </div>
      </div>

      <div class="dropdown">
        <button class="dropdown-button">Micro Plastics</button>
        <div class="dropdown-content">
          <a href="step1_micro.html">Conduct a survey</a>
          <a href="display_micro.html">Dashboard</a>
        </div>
      </div>
    </div>
  </div>
  <div class="dashboard">
    <h2>Macroplastic Survey Data</h2>

    <table id="macroTable">
    <thead>
        <tr>
            <th>Country Code</th>
            <th>Sea Site ID</th>
            <th>Survey ID</th>
            <th>Date</th>
            <th>Number of Pollutants</th>
            <th>Category</th>
        </tr>
    </thead>
    <tbody></tbody>
    </table>
    <button onclick="exportToExcel()">Export Table to Excel</button>

    <canvas id="categoryChart" width="800" height="400"></canvas>


    <button onclick="exportChart()">Export Chart to Image</button>
  </div>
    

<script>
  // Initialize Firebase
  const firebaseConfig = {
      apiKey: "AIzaSyCiUYF1MeV9seUzZpkVMSTYQr87r-pXitk",
      authDomain: "marinelitter-410a0.firebaseapp.com",
      databaseURL: "https://marinelitter-410a0-default-rtdb.firebaseio.com",
      projectId: "marinelitter-410a0",
      storageBucket: "marinelitter-410a0.appspot.com",
      messagingSenderId: "902858063996",
      appId: "1:902858063996:web:7a7a9f43cb449d98b089f9"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const tableBody = document.querySelector("#macroTable tbody");
  const categoryCounts = {};

  function fetchAndDisplay() {
    db.ref("macroSurveys").once("value", snapshot => {
      const data = snapshot.val();
      for (const surveyId in data) {
        const entry = data[surveyId];
        const country = entry["Country Code"] || "";
        const seaSite = entry["Sea Site ID"] || "";
        const date = entry["Date"] || "";
        const survey = entry["Survey ID"] || surveyId;

        const pollutants = entry.pollutants || [];
        let totalPollutants = 0;
        let categories = [];

        pollutants.forEach(p => {
          const cat = p.Category || "Unknown";
          const count = parseInt(p.Number || "0");
          totalPollutants += count;

          if (!categoryCounts[cat]) categoryCounts[cat] = 0;
          categoryCounts[cat] += count;

          if (!categories.includes(cat)) categories.push(cat);
        });

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${country}</td>
          <td>${seaSite}</td>
          <td>${survey}</td>
          <td>${date}</td>
          <td>${totalPollutants}</td>
          <td>${categories.join(", ")}</td>
        `;
        tableBody.appendChild(tr);
      }

      drawChart();
    });
  }

  function drawChart() {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(categoryCounts),
        datasets: [{
          label: 'Pollutant Count by Category',
          data: Object.values(categoryCounts),
          backgroundColor: 'rgba(54, 162, 235, 0.6)'
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }


  async function exportToExcel() {
    const [stationsSnap, seasSnap, surveysSnap] = await Promise.all([
      db.ref("macroStations").once("value"),
      db.ref("macroSeaSites").once("value"),
      db.ref("macroSurveys").once("value")
    ]);

    const stations = stationsSnap.val() || {};
    const seas = seasSnap.val() || {};
    const surveys = surveysSnap.val() || {};

    // Step 1: Define field order arrays
    const stationFields = [
      "countryCode", "stationId", "stationName", "latitude", "longitude", "region", "remarks"
    ];

    const seaFields = [
      "Country code", "station ID", "sea site ID", "Sea Site Name", "Latitude start 100m", "longitude start 100m",
      "latitude end 100m", "longitude end 100m", "Prevailing Currents", "Prevailing Winds", "Marine Traffic & Infrastructure",
      "Shipping Lane Distance (km)", "Shipping Lane Position", "Traffic Density", "Traffic Type",
      "Harbour Present?", "Aquaculture Present?", "Wastewater Discharge Present?", "Fishing Activity in Area", "Fishing Season",
      "Surfing Zones Nearby", "Surfing Season", "Sailing Activity in Area", "Sailing Season", "Access by Boat",
      "Nearest Town", "Town Location", "Town Distance (km)", "Town Population", "Remarks"
    ];

    const surveyFields = [
      "Survey ID", "Sea Site ID", "Sea Site Name", "Country Code", "Latitude Start 100m", "Longitude Start 100m",
      "Latitude End 100m", "Longitude End 100m", "Transect Lenght", "Date", "Time", "Weather Conditions",
      "Number of Surveyors", "Name of Surveyor", "Telephone of Surveyor", "Email of Surveyor", "Animals",
      "Animals Species", "Animals Number", "Animals State", "Entangled Animals", "Entangled Animals Litter",
      "Special Circumstances", "Special Circumstances Type", "Unusual Items", "Unusual Items Description",
      "Presence of pellets", "Presence of oil tars", "Encountered Pollutants", "Last Cleaning Date",
      "Photo ID", "Remarks"
    ];

    const stationArray = Object.values(stations).map(obj => reorder(obj, stationFields));
    const seaArray = Object.values(seas).map(obj => reorder(obj, seaFields));
    const surveyArray = Object.values(surveys).map(obj => reorder(obj, surveyFields));

    // Step 2: Flatten pollutants
    const allPollutants = [];
    for (const surveyId in surveys) {
      const entry = surveys[surveyId];
      const pollutants = entry.pollutants || [];
      if (Array.isArray(pollutants)) {
        pollutants.forEach(p => {
          allPollutants.push({
            SurveyID: surveyId,
            ...p
          });
        });
      }
    }

    // Step 3: Create workbook and append sheets
    const wb = XLSX.utils.book_new();
    if (stationArray.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(stationArray), "Station Info");
    if (seaArray.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(seaArray), "Sea Info");
    if (surveyArray.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(surveyArray), "Survey Info");
    if (allPollutants.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allPollutants), "Pollutants");

    XLSX.writeFile(wb, `macro_journeys_all.xlsx`);
  }

  // Helper to reorder object keys
  function reorder(obj, fields) {
    const reordered = {};
    fields.forEach(f => {
      reordered[f] = obj[f] || "";
    });
    return reordered;
  }



  fetchAndDisplay();
</script>

</body>
</html>




